<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>××“ ×¦×¢×“×™× ×—×›×</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.rtl.min.css" rel="stylesheet"/>
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <link href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" rel="stylesheet"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body.dark { background-color: #121212; color: #fff; }
    body.light { background-color: #f8f9fa; color: #000; }
    #map { height: 180px; border-radius: 10px; }
    canvas { background: #fff; border-radius: 10px; }
    .card { transition: 0.3s ease-in-out; }
    .card:hover { transform: scale(1.01); }
    .top-bar { display: flex; justify-content: space-between; align-items: center; }
    .top-buttons button { margin-left: 0.5rem; }
    .footer { text-align: center; font-size: 0.9em; margin-top: 5px; }
    .nowrap { white-space: nowrap; }
    html, body { height: 100vh; overflow: hidden; }
    .container { max-height: 100vh; overflow-y: auto; }
    /*#addToHome { display: none; }*/
  </style>
</head>
<body class="dark">
<div class="container py-2">

  <div class="top-bar mb-2">
    <div class="top-buttons">
      <button class="btn btn-sm btn-outline-light" id="themeToggle">ğŸŒ™</button>
      <button class="btn btn-sm btn-outline-danger" id="resetBtn">ğŸ”„</button>
    </div>
    <h5 class="mb-0">ğŸš¶ ××“ ×¦×¢×“×™× ×—×›×</h5>
  </div>

  <div class="row g-2">
    <div class="col-md-4">
      <div class="card p-2">
        <h6>×¦×¢×“×™×: <span id="stepCount">0</span></h6>
        <h6>××¨×—×§: <span id="distance">0</span> ×'</h6>
        <h6>××”×™×¨×•×ª: <span id="speed">0</span> ×§×"×©</h6>
        <button class="btn btn-danger btn-sm mt-2 w-100" id="stopBtn">×¢×¦×•×¨ ××“×™×“×”</button>
      </div>
    </div>

    <div class="col-md-4">
      <div class="card p-2">
        <div class="d-flex align-items-center justify-content-between nowrap">
          <label class="me-2">×¦×œ×™×œ ×›×œ:</label>
          <input type="number" id="soundInterval" class="form-control form-control-sm w-50 me-2" min="10" step="10" value="100"/>
          <span>×'</span>
          <button class="btn btn-primary btn-sm ms-2" id="playTest">ğŸ”Š</button>
        </div>
        <audio id="stepSound" src="https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg" preload="auto"></audio>
      </div>
    </div>

    <div class="col-md-4">
      <div class="card p-2">
        <div class="d-flex justify-content-between align-items-center">
          <span>ğŸ—ºï¸ ××™×§×•×</span>
          <button class="btn btn-outline-secondary btn-sm" id="centerMap">××¨×›×–</button>
        </div>
        <div id="map" class="mt-2"></div>
      </div>
    </div>
  </div>

  <canvas id="distanceChart" class="w-100 my-2" height="90"></canvas>
  <div class="text-center my-2">
    <button id="addToHome" class="btn btn-success btn-sm">â• ×”×•×¡×£ ×œ××¡×š ×”×‘×™×ª</button>
  </div>
  <div class="footer">Snir Elgabsi (c)</div>
</div>

<script>
let steps = +localStorage.getItem("steps") || 0;
let totalDistance = +localStorage.getItem("distance") || 0;
let lastCoords = null;
let lastTime = null;
let isRunning = true;
let distanceHistory = JSON.parse(localStorage.getItem("distanceHistory") || "[]");
let soundInterval = +localStorage.getItem("soundInterval") || 100;
let theme = localStorage.getItem("theme") || "dark";
let chart = null;
let userLatLng = [31.7683, 35.2137];

$('#stepCount').text(steps);
$('#distance').text(totalDistance.toFixed(1));
$('#soundInterval').val(soundInterval);
$('body').removeClass().addClass(theme);
$('#themeToggle').html(theme === 'dark' ? 'ğŸŒ™' : 'â˜€ï¸');

// ×”×—×œ×¤×ª ××¦×‘ ×ª×¦×•×’×”
$('#themeToggle').on('click', function () {
  theme = theme === 'dark' ? 'light' : 'dark';
  $('body').removeClass().addClass(theme);
  $(this).html(theme === 'dark' ? 'ğŸŒ™' : 'â˜€ï¸');
  localStorage.setItem("theme", theme);
});

// ××™×¤×•×¡ ×›×œ×œ×™
$('#resetBtn').on('click', function () {
  if (confirm("×œ××¤×¡ ××ª ×›×œ ×”× ×ª×•× ×™×?")) {
    localStorage.clear();
    location.reload();
  }
});

$('#playTest').on('click', function () {
  $('#stepSound')[0].play();
});

$('#soundInterval').on('change', function () {
  soundInterval = +$(this).val();
  localStorage.setItem("soundInterval", soundInterval);
});

$('#stopBtn').on('click', function () {
  isRunning = false;
  alert("××“×™×“×” × ×¢×¦×¨×”.");
});

if (window.DeviceMotionEvent) {
  let stepBuffer = 0;
  window.addEventListener('devicemotion', e => {
    if (!isRunning) return;
    let acc = e.accelerationIncludingGravity;
    let magnitude = Math.sqrt(acc.x ** 2 + acc.y ** 2 + acc.z ** 2);
    if (magnitude > 15) {
      stepBuffer++;
      if (stepBuffer > 5) {
        steps++;
        $('#stepCount').text(steps);
        localStorage.setItem("steps", steps);
        stepBuffer = 0;
      }
    }
  });
}

// ××¤×”
let map = L.map('map', { scrollWheelZoom: true }).setView(userLatLng, 14);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
let userMarker = L.marker(userLatLng).addTo(map);
$('#centerMap').click(() => map.setView(userLatLng, 16));

// GPS ×•××¨×—×§
navigator.geolocation.watchPosition(pos => {
  if (!isRunning) return;
  const { latitude, longitude } = pos.coords;
  userLatLng = [latitude, longitude];

  const now = new Date().getTime();
  if (lastCoords) {
    let d = calcDistance(lastCoords.lat, lastCoords.lng, latitude, longitude);
    if (d > 1) {
      totalDistance += d;
      $('#distance').text(totalDistance.toFixed(1));
      localStorage.setItem("distance", totalDistance);
      distanceHistory.push({ time: now, distance: totalDistance });
      localStorage.setItem("distanceHistory", JSON.stringify(distanceHistory));
      if (lastTime) {
        let deltaSec = (now - lastTime) / 1000;
        let speed = (d / deltaSec) * 3.6;
        $('#speed').text(speed.toFixed(1));
      }
      if (Math.floor(totalDistance / soundInterval) > Math.floor((totalDistance - d) / soundInterval)) {
        $('#stepSound')[0].play();
      }
    }
  }
  lastCoords = { lat: latitude, lng: longitude };
  lastTime = now;
  userMarker.setLatLng(userLatLng);
  updateChart();
}, err => {
  alert("××™×Ÿ ×’×™×©×” ×œÖ¾GPS");
});

// ×—×™×©×•×‘ ××¨×—×§
function calcDistance(lat1, lon1, lat2, lon2) {
  const R = 6371000;
  const dLat = (lat2 - lat1) * Math.PI / 180;
  const dLon = (lon2 - lon1) * Math.PI / 180;
  const a = Math.sin(dLat/2)**2 +
            Math.cos(lat1 * Math.PI/180) * Math.cos(lat2 * Math.PI/180) *
            Math.sin(dLon/2)**2;
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  return R * c;
}

// ×’×¨×£
function updateChart() {
  let labels = distanceHistory.map(p => new Date(p.time).toLocaleTimeString());
  let data = distanceHistory.map(p => p.distance.toFixed(1));
  if (!chart) {
    chart = new Chart(document.getElementById('distanceChart'), {
      type: 'line',
      data: {
        labels: labels,
        datasets: [{
          label: '××¨×—×§ ××¦×˜×‘×¨ (××³)',
          data: data,
          borderColor: 'blue',
          backgroundColor: 'rgba(0,0,255,0.1)',
          tension: 0.4
        }]
      },
      options: {
        responsive: true,
        animation: { duration: 500 },
        plugins: { legend: { display: false } },
        scales: { x: { display: false }, y: { display: false } }
      }
    });
  } else {
    chart.data.labels = labels;
    chart.data.datasets[0].data = data;
    chart.update();
  }
}
</script>
  <!-- Add Bookmark -->
  <script>
let deferredPrompt = null;

// ×××–×™×Ÿ ×œ××™×¨×•×¢ ×©×××¤×©×¨ ×”×ª×§× ×”
window.addEventListener('beforeinstallprompt', (e) => {
  e.preventDefault();
  deferredPrompt = e;
  $('#addToHome').show();
});

// ×œ×—×™×¦×” ×¢×œ ×›×¤×ª×•×¨ "×”×•×¡×£ ×œ××¡×š ×”×‘×™×ª"
$('#addToHome').on('click', async () => {
  if (deferredPrompt) {
    deferredPrompt.prompt();
    const result = await deferredPrompt.userChoice;
    if (result.outcome === 'accepted') {
      console.log('×”××©×ª××© ×”×•×¡×™×£ ×œ××¡×š ×”×‘×™×ª');
    }
    deferredPrompt = null;
    $('#addToHome').hide();
  } else {
    alert('× ×™×ª×Ÿ ×œ×”×•×¡×™×£ ×œ××¡×š ×”×‘×™×ª ×“×¨×š ×ª×¤×¨×™×˜ ×”×“×¤×“×¤×Ÿ');
  }
});
</script>

</body>
</html>
